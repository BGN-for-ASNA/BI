---
title: "BI"
author: "Sebastian sosa"
date: "2024-09-09"
output: html_document
---

# Runing STRAND example

```{r}
#####################################
#
#   Binomial Analyses - Simulated data  
#
########################################

# Clear working space
rm(list = ls())
set.seed(10)
# Load libraries
library(STRAND)
library(rethinking)
library(ggplot2)

libr
# Make data
N_id = 100

# Covariates
Kinship = rlkjcorr( 1 , N_id , eta=1.5 )
Dominant = ceiling(rlkjcorr( 1 , N_id , eta=1.5 ) - 0.1)
Mass = rbern(N_id, 0.4)

# Organize into list
dyadic_preds = array(NA,c(N_id,N_id,3))

dyadic_preds[,,1] = Kinship
dyadic_preds[,,2] = Dominant
dyadic_preds[,,3] = Kinship*Dominant

# Set effect sizes
sr_mu = c(0,0)  
sr_sigma = c(2.2, 1.7) 
sr_rho = 0.55
dr_mu = 0 
dr_sigma = 1.5
dr_rho= 0.6
sr_effects_1 = c(1.9, 1.3)
dr_effects_1 = c(1.2, 1.7, -2.2)

## Block structure
#group_probs_block_size = c(0.25, c(0.25, 0.25)*(1-0.25))
#
#B_1 = matrix(-10,nrow=1,ncol=1)
#B_2 = matrix(rnorm(9,0,3),nrow=3,ncol=3)
#B_3 = matrix(rnorm(4,0,3),nrow=2,ncol=2)
#
#diag(B_2) = diag(B_2) + 2
#diag(B_3) = diag(B_3) + 3.5
#
#B=list(B_1, B_2, B_3)
# 
#groups_1 = rep("Any",N_id) 
#groups_2 = sample( c("Red","White","Blue") , size=N_id , replace=TRUE , prob=group_probs_block_size )
#groups_3 = sample( c("Strange", "Charm") , size=N_id , replace=TRUE , prob=c(0.5,0.5) )
#
#groups = data.frame(Intercept=as.numeric(factor(groups_1)), Merica=as.numeric(factor(groups_2)), Quantum=as.numeric(factor(groups_3)))
#groups_f = data.frame(Intercept=factor(groups_1), Merica=factor(groups_2), Quantum=factor(groups_3))

#################################################### Simulate SBM + SRM network
G = simulate_srm_network(N_id = N_id, 
                         #B = B, 
                         #V=3,
                         #groups=groups,                  
                         sr_mu = sr_mu,  
                         sr_sigma = sr_sigma, 
                         sr_rho = sr_rho,
                         dr_mu = dr_mu,  
                         dr_sigma = dr_sigma, 
                         dr_rho = dr_rho,
                         mode="binomial",                  
                         individual_predictors = data.frame(Mass=Mass),
                         dyadic_predictors = dyadic_preds,
                         individual_effects = matrix(sr_effects_1,nrow=2,ncol=1),
                         dyadic_effects = dr_effects_1
                         )        

################################################### Organize for model fitting
model_dat = make_strand_data(outcome=list(G$network),  block_covariates=groups_f, individual_covariates=data.frame(Mass=Mass), 
                           dyadic_covariates=list(Kinship=Kinship, Dominant=Dominant),  outcome_mode = "binomial", exposure=list(G$samps))

# Model the data with STRAND
fit =  fit_block_plus_social_relations_model(data=model_dat,
                            block_regression = ~ Merica + Quantum,
                              focal_regression = ~ Mass,
                              target_regression = ~ Mass,
                              dyad_regression = ~ Kinship*Dominant,
                              mode="mcmc",
                              stan_mcmc_parameters = list(chains = 1, parallel_chains = 1, refresh = 1,
                                                          iter_warmup = 1000, iter_sampling = 1000,
                                                          max_treedepth = NULL, adapt_delta = .9)
)

# Check parameter recovery
res = summarize_strand_results(fit)

install.packages()
```


# Importing BI simulated data 
```{python}
from main import *
m = bi(platform='cpu')
import json
import jax.numpy as jnp
with open('OUTPUT STRAND.json', 'r') as f:
    data = json.load(f)
data.keys()
print("N_networktypes: ")
print(data['N_networktypes'])
print("N_id : ")
print(data['N_id'])
print("N_responses : ")
print(data['N_responses'])
print("N_periods : ")
print(data['N_periods'])
print("N_periods : ")
print(data['N_periods'])
print("N_individual_predictors : " )
print(data['N_individual_predictors'])
print("N_dyadic_predictors : ")
print(data['N_dyadic_predictors'])
print("flows : ")
print(data['flows'])
data['individual_predictors'] = jnp.array([item['Mass'] for item in data['individual_predictors']])
print("individual_predictors : ")
print(data['individual_predictors'])
#print("N_block_predictors : ")
#print(data['N_block_predictors'])
#print("N_groups_per_block_type : ")
#print(data['N_groups_per_block_type'])
#print("outcome_mode : ")
#print(data['outcome_mode'] )
#data['block_predictors'] = jnp.array([item['Merica'] for item in data['block_predictors']])
print("block_predictors : ")
print(data['block_predictors'] )
print("outcome_mode : ")
print(data['outcome_mode'] )

Kinship = jnp.array(data['dyadic_predictors']['Kinship'])
print(Kinship.shape)
Dominant = jnp.array(data['dyadic_predictors']['Dominant'])
print(Dominant.shape)
exposure = jnp.array(data['exposure'])[:,:,1]
print(exposure.shape)

# Matrices to edgelist
result_dom = bi.net.mat_to_edgl(Dominant)
result_dom.shape
result_kin = bi.net.mat_to_edgl(Kinship)
result_kin
data['outcomes'] = jnp.array(data['outcomes'])
result_outcomes = bi.net.mat_to_edgl(data['outcomes'][:,:,0])
print(result_outcomes.shape)

N_id = data['individual_predictors'].shape[0]
print((N_id*(N_id-1))/2)
focal_individual_predictors = data['individual_predictors']
target_individual_predictors = data['individual_predictors']

```


