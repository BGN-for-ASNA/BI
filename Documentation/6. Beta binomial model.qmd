# Beta-Binomial Model
## General Principles
To model the relationship between a binary outcome variable representing success counts and one or more independent variables with [<span style="color:#0D6EFD">overdispersion ğŸ›ˆ</span>]{#overdispersion}, we can use the _Beta-Binomial model_.

## Considerations
::: callout-caution 
- We have the same considerations as for [Binomial regression](5.&#32;Binomial&#32;model.qmd).

- A Beta-Binomial model assumes that each binomial count observation has its own probability of success. The model estimates the distribution of probabilities of success across cases, instead of a single probability of success.
  
- A Beta distribution has two parameters: the rates for each probabilities and a shape parameter Î¸. Î¸ influence how probabilities are distributed between 0 and 1. Specifically, it consists of two parameters, $\gamma$  and $\eta$ , which determine the concentration of probability around 0 and 1. The values of ğ›¼ and ğ›½ shape the distribution:

  - If both are greater than 1, the distribution is bell-shaped and centered around the mean ğ‘. 

  - If $\gamma$ < 1 and $\eta$ < 1, the distribution is U-shaped, indicating that outcomes are more likely to be near 0 or 1.

  - If ğ›¼ = $\gamma$ and $\eta$ = 1, the Beta distribution is uniform. 

Thus, the shape parameters ğ›¼ $\gamma$ $\eta$ provide flexibility in modeling various types of prior beliefs about probabilities.
  
:::

## Example
Below is an example code snippet demonstrating Bayesian Beta-Binomial regression using the Bayesian Inference (BI) package. The data consist of:

1) One binary dependent variable (admit), which represents candidates' admission status.

2) One independent categorical variable representing individuals' gender (gid).

3) Additionally, we have the number of applications (applications) per individual, which will be used to account for independent rates.

The goal is to evaluate whether the probability of admission is different between genders, while accounting for differences in the number of applications between genders.

::: {.panel-tabset group="language"}
### Python
```python
from main import*#
# Setup device------------------------------------------------
m = bi()

# Import Data & Data Manipulation ------------------------------------------------
m.data('../data/UCBadmit.csv', sep=';') # Import
# Data type (int, float is important, specially for indices)
m.df["gid"] = (m.df["applicant.gender"] != "male").astype(int) # Manipulate
gid = jnp.array(m.df["gid"].astype('int32').values) # Manipulate
applications = jnp.array(m.df["applications"].astype('float32').values) # Manipulate
admit = jnp.array(m.df["admit"].astype('float32').values) # Manipulate

# Send to model (convert to jax array)
m.data_on_model = dict(
    gid=gid,
    applications=applications,
    admit=admit
) 

# Define model ------------------------------------------------
def model(gid, applications, admit):
    phi = dist.exponential(1, shape=(1,), name = 'phi')
    alpha = dist.normal( 0., 1.5, shape=(2,), name = 'alpha')
    theta = phi + 2
    pbar = jax.nn.sigmoid(alpha[gid])
    concentration1 = pbar*theta
    concentration0 = (1 - pbar) * theta

    m.betabinomial(total_count = applications, concentration1 = concentration1, concentration0 = concentration0, obs=admit)

# Run MCMC ------------------------------------------------
m.run(model) # Optimize model parameters through MCMC sampling

# Summary ------------------------------------------------
m.summary()
```
### R
``` R
library(BI)

# setup platform------------------------------------------------
m=importBI(platform='cpu')

# import data ------------------------------------------------
m$data(paste(system.file(package = "BI"),"/data/UCBadmit.csv", sep = ''), sep=';')
m$df["gid"] = as.integer(ifelse(m$df["applicant.gender"] == "male", 0, 1)) # Manipulate
m$data_to_model(list('gid', 'applications', 'admit' )) # Send to model (convert to jax array)

# Define model ------------------------------------------------
model <- function(gid, applications, admit){
  # Parameters priors distributions
  phi = bi.dist.exponential(1, name = 'phi',shape=c(1))
  alpha = bi.dist.normal(0., 1.5, shape= c(2), name='alpha')
  t = phi + 2
  pbar = jax$nn$sigmoid(alpha[gid])
  gamma = pbar * t
  eta = (1 - pbar) * t
  # Likelihood
  m$betabinomial(total_count=applications, concentration1=gamma, concentration0=eta, obs=admit)
}

# Run MCMC ------------------------------------------------
m$run(model) # Optimize model parameters through MCMC sampling

# Summary ------------------------------------------------
m$summary() # Get posterior distribution

```

:::
## Mathematical Details
### *Frequentist formulation*
???

### *Bayesian Model*
In the Bayesian formulation, we define each parameter with [<span style="color:#0D6EFD">priors ğŸ›ˆ</span>]{#prior}. We can express the Bayesian regression model accounting for prior distribution as follows:

$$
Y_i \sim BetaBinomial(n_i, \gamma_i, \eta_i)
$$

$$
\gamma_i = \overline{\rho}   \tau 
$$

$$
\eta_i = (1 - \overline{\rho} ) \tau 
$$

$$
\overline{\rho} = logit(\alpha_i)
$$

$$
\tau = \phi + 2
$$

$$
\alpha \sim Normal(0,1)
$$

$$
\phi \sim Exponential(1)
$$

Where:

- $Y_i$ is the ount of successes for the *i*-th observation, which follows a beta-binomial distribution with $n_i$ trials.

- $\gamma_i$ represents the concentration parameter for the number of successes, derived from the probability of success and scaled by $\tau$.
  
- $\eta_i$ represents the concentration parameter for failures, derived from the probability of failure $(1 - \overline{\rho} )$ and also scaled by $\tau$.

- $\overline{\rho}$ is the probability of success for the *i*-th observation. The logit function transforms the linear predictor Î± (which can take any real value) into a probability value between 0 and 1. 
  
- $\tau$ is derived from ğœ™ and is used as a scaling factor for the shape parameters ğ›¾ and ğœ‚.
  
- Î± is a vector of parameters, each representing the effect of the group variable *i on the success probability.

- Ï• is a random variable following an exponential distribution with a rate of 1.


## Reference(s)
@mcelreath2018statistical


