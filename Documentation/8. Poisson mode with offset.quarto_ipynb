{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
<<<<<<< HEAD
        "title: \"ðŸš§ Poisson Model with an Offset ðŸš§\"\n",
=======
        "title: \"ðŸš§ Poisson Model with an Offset\"\n",
>>>>>>> 9ba7a667d655f408e7b5a9c3897d8b55113721d1
        "description: \"Modeling count data that has been collected over different levels of exposure using an offset.\"\n",
        "categories: [Regression,  Count Data]\n",
        "image: \"Figures/7.png\"\n",
        "order: 9\n",
        "---\n",
        "\n",
<<<<<<< HEAD
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
=======
>>>>>>> 9ba7a667d655f408e7b5a9c3897d8b55113721d1
        "## General Principles\n",
        "When we want to model count data, where the counts are observed over different periods or areas of exposure, we use a _Poisson model with an offset_. This is a type of generalized linear model used for modeling count data and contingency tables.\n",
        "\n",
        "An _offset_ is a predictor variable with a coefficient that is fixed at 1. It is used to account for the \"exposure\" variable, which represents the opportunity for an event to occur. For instance, if we are counting the number of sick individuals in different cities, the population of each city would be the exposure variable. A city with a larger population is expected to have more sick individuals. The offset accounts for this by essentially modeling the rate of events per unit of exposure.\n",
        "\n",
        "## Considerations\n",
        "::: callout-note\n",
        "- The dependent variable in a Poisson regression must be a non-negative count.\n",
        "\n",
        "- The exposure variable used as an offset cannot contain zeros.\n",
        "\n",
        "- A key assumption of the Poisson distribution is that the mean and variance of the count variable are equal. If the variance is greater than the mean, a condition known as overdispersion, a Negative Binomial regression might be more appropriate.\n",
        "\n",
        "- The logarithm of the exposure variable is typically used as the offset. This is because Poisson regression models the logarithm of the expected count. By including the log of the exposure as an offset, we are effectively modeling the rate.\n",
        ":::\n",
        "\n",
        "## Example\n",
        "Below is an example of code that demonstrates a Bayesian Poisson regression with an offset. The data consists of the number of elephant aggressions (`agressions`), the age of the elephants (`age`), and the number of years they have been observed (`years_obs`). The goal is to model the rate of aggressions per year, accounting for the age of the elephants.\n",
        "\n",
        "::: {.panel-tabset group=\"language\"}\n",
<<<<<<< HEAD
        "### Python\n"
      ],
      "id": "1e6ac56a"
=======
        "### Python\n",
        "<!---"
      ],
      "id": "bc465bcb"
>>>>>>> 9ba7a667d655f408e7b5a9c3897d8b55113721d1
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
<<<<<<< HEAD
        "from BI import bi\n",
        "import jax.numpy as jnp\n",
        "# Setup device------------------------------------------------\n",
        "m = bi(platform='cpu')\n",
        "\n",
        "# import data ------------------------------------------------\n",
        "# Import\n",
        "from importlib.resources import files\n",
        "data_path = m.load.kline(only_path = True)\n",
        "m.data(data_path, sep=';')\n",
        "m.scale(['population'])\n",
        "m.df[\"cid\"] = (m.df.contact == \"high\").astype(int)\n",
        "#m.data_to_model(['total_tools', 'population', 'cid'])\n",
        "def model(cid, population, total_tools):\n",
        "    a = m.dist.normal(3, 0.5, shape= (2,), name='a')\n",
        "    b = m.dist.normal(0, 0.2, shape=(2,), name='b')\n",
        "    l = jnp.exp(a[cid] + b[cid]*population + )\n",
        "    m.dist.poisson(l, obs=total_tools)\n",
        "\n",
        "# Run sampler ------------------------------------------------\n",
        "m.fit(model)\n",
        "\n",
        "# Diagnostic ------------------------------------------------\n",
        "m.summary()"
      ],
      "id": "63d43c51",
=======
        "#from BI import bi, jnp\n",
        "#\n",
        "## Setup device------------------------------------------------\n",
        "#m = bi(platform='cpu')\n",
        "#\n",
        "## Import Data & Data Manipulation ------------------------------------------------\n",
        "## Import\n",
        "#m.data('elephants.csv', sep=';') \n",
        "#jnp.log(['years_obs']) # Log transform the exposure variable\n",
        "#m.data_to_model(['agressions', 'age', \"log_years_obs\"]) # Send to model\n",
        "#\n",
        "## Define model ------------------------------------------------\n",
        "#def model(agressions, age, log_years_obs):\n",
        "#    a = m.bi.dist.normal(0, 1, name = 'a') \n",
        "#    b = m.bi.dist.normal(0, 0.5, name = 'b')\n",
        "#    log_lambda = a + b * age + log_years_obs # Add offset to the linear model\n",
        "#    m.dist.poisson(jnp.exp(log_lambda), obs=agressions)\n",
        "#\n",
        "#\n",
        "## Run mcmc ------------------------------------------------\n",
        "#m.fit(model) # Optimize model parameters through MCMC sampling\n",
        "#\n",
        "## Summary ------------------------------------------------\n",
        "#m.summary()"
      ],
      "id": "e11d6b5d",
>>>>>>> 9ba7a667d655f408e7b5a9c3897d8b55113721d1
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
<<<<<<< HEAD
=======
        "--->\n",
        "\n",
>>>>>>> 9ba7a667d655f408e7b5a9c3897d8b55113721d1
        "![](travaux-routiers.png){fig-align=\"center\"}\n",
        "\n",
        "### R\n",
        "<!---\n",
        "```R\n",
        "library(BayesianInference)\n",
        "m=importBI(platform='cpu')\n",
        "\n",
        "# Load csv file\n",
        "m$data(paste(system.file(package = \"BayesianInference\"),\"/data/elephants.csv\", sep = ''), sep=',')\n",
        "m$log(list('years_obs')) # Log transform the exposure variable\n",
        "m$data_to_model(list('agressions', 'age', 'log_years_obs')) # Send to model\n",
        "\n",
        "# Define model ------------------------------------------------\n",
        "model <- function(agressions, age, log_years_obs){\n",
        "  # Parameter prior distributions\n",
        "  a = bi.dist.normal(0, 1, name = 'a')\n",
        "  b = bi.dist.normal(0, 0.5, name = 'b')\n",
        "  # Likelihood\n",
        "  log_lambda = a + b * age + log_years_obs # Add offset to the linear model\n",
        "  m$poisson(exp(log_lambda), obs=agressions)\n",
        "}\n",
        "\n",
        "# Run mcmc ------------------------------------------------\n",
        "m$fit(model) # Optimize model parameters through MCMC sampling\n",
        "\n",
        "# Summary ------------------------------------------------\n",
        "m$summary() # Get posterior distributions\n",
        "```\n",
        "--->\n",
        "![](travaux-routiers.png){fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "## Mathematical Details\n",
        "### *Frequentist formulation*\n",
        "We model the relationship between the independent variables (X) and the expected count (Î») using the following equation:\n",
        "\n",
        "$$\n",
        "\\log(\\lambda_i) = \\alpha + \\beta X_i + \\log(\\text{exposure}_i)\n",
        "$$\n",
        "\n",
        "Where:\n",
        "\n",
        "- $\\lambda_i$ is the expected count for observation *i*.\n",
        "- $\\alpha$ is the intercept term.\n",
        "- $\\beta$ is the regression coefficient for the independent variable.\n",
        "- $X_i$ is the value of the independent variable for observation *i*.\n",
        "- $\\log(\\text{exposure}_i)$ is the offset, which is the natural logarithm of the exposure for observation *i*.\n",
        "\n",
        "The number of observed counts $Y_i$ is assumed to follow a Poisson distribution with mean $\\lambda_i$:\n",
        "\n",
        "$$\n",
        "Y_i \\sim \\text{Poisson}(\\lambda_i)\n",
        "$$\n",
        "\n",
        "### *Bayesian formulation*\n",
        "In the Bayesian framework, we assign prior distributions to the model parameters. The model can be expressed as:\n",
        "\n",
        "$$\n",
        "Y_i \\sim \\text{Poisson}(\\lambda_i)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\log(\\lambda_i) = \\alpha + \\beta X_i + \\log(\\text{exposure}_i)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\alpha \\sim \\text{Normal}(0,1)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\beta \\sim \\text{Normal}(0,1)\n",
        "$$\n",
        "\n",
        "Where:\n",
        "\n",
        "- $Y_i$ is the observed count for observation *i*.\n",
        "- $\\lambda_i$ is the expected count.\n",
        "- $\\alpha$ is the intercept with a unit-normal prior.\n",
        "- $\\beta$ is the slope coefficient with a unit-normal prior.\n",
        "- $X_i$ is the independent variable.\n",
        "- $\\log(\\text{exposure}_i)$ is the offset.\n",
        "\n",
        "## Notes\n",
        "::: callout-note\n",
        "\n",
        "- The use of an offset is crucial when the goal is to compare rates of events rather than absolute counts.\n",
        "\n",
        "- It is a common practice to use the natural logarithm of the exposure variable as the offset.\n",
        ":::\n",
        "\n",
        "## Reference(s)"
      ],
<<<<<<< HEAD
      "id": "06c49bf1"
=======
      "id": "7dbaaaf6"
>>>>>>> 9ba7a667d655f408e7b5a9c3897d8b55113721d1
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "/home/sosa/.local/share/jupyter/kernels/python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}