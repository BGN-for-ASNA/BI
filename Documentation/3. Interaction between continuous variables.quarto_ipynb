{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Interaction Terms in Regression\"\n",
        "description: \"Modeling how the effect of one independent variable on the outcome changes based on the value of another independent variable.\"\n",
        "categories: [Regression]\n",
        "image: \"Figures/3.png\"\n",
        "order: 4\n",
        "---\n",
        "\n",
        "\n",
        "## General Principles\n",
        "If you have a case where you believe the effect of one independent variable depends on the value of another independent variable, you can use regression analysis with interaction terms. In this approach, we extend the simple linear regression model to include an interaction term (a multiplication) between the two independent variables (see [note](#Notes) on how this multiplication arises).\n",
        "\n",
        "## Considerations\n",
        "::: callout-note\n",
        "- We have the same assumptions as for [Regression for continuous variable](1.&#32;Linear&#32;Regression&#32;for&#32;continuous&#32;variable.qmd).\n",
        "\n",
        "- We wish to model the relationship between a dependent variable, *Y*, and an independent variable,  $X_1$, whose effect varies as a function of a second independent variable $X_2$. To do this, we explicitly model the hypothesis that the slope between *Y* and $X_1$ depends on (i.e., is conditional on) $X_2$.\n",
        "\n",
        "- For continuous interactions with normalized data, the intercept becomes the [<span style=\"color:#0D6EFD\">grand mean ðŸ›ˆ</span>]{#grandMean} of the outcome variable.\n",
        "\n",
        "- The interpretation of slopes estimates is more complex. The coefficient for a non-interaction term reflects the expected change in *Y* when $X_1$ increases by one unit, holding $X_2$ constant at its average value. The coefficient for the interaction term represents how the effect of $X_1$ on *Y* changes depending on the value of $X_2$, and vice versa, showing how the relationship between the two variables influences the outcome *Y*.\n",
        "\n",
        "- [<span style=\"color:#0D6EFD\">Triptych ðŸ›ˆ</span>]{#triptych} plots are very handy for understanding the impact of interactions, especially when more than two interactions are present.\n",
        "\n",
        ":::\n",
        "\n",
        "## Example\n",
        "Below is example code demonstrating Bayesian regression with an interaction term between two continuous variables using the Bayesian Inference (BI) package. The data consist of three continuous variables (temperature, humidity, energy consumption), and the goal is to estimate the effect of the interaction between temperature and humidity on energy consumption. This example is based on @mcelreath2018statistical.\n",
        "\n",
        "::: {.panel-tabset group=\"language\"}\n",
        "### Python"
      ],
      "id": "2a033d70"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "from BI import bi\n",
        "\n",
        "# Setup device------------------------------------------------\n",
        "m = bi(platform='cpu')\n",
        "\n",
        "# Import Data & Data Manipulation ------------------------------------------------\n",
        "# Import\n",
        "from importlib.resources import files\n",
        "data_path = m.load.tulips(only_path = True)\n",
        "m.data(data_path, sep=';')\n",
        "m.scale(['blooms', 'water', 'shade']) # Normalize\n",
        "\n",
        "\n",
        "# Define model ------------------------------------------------\n",
        "def model(blooms,shade, water):\n",
        "    sigma = m.dist.exponential(1, name = 'sigma', shape = (1,))\n",
        "    bws = m.dist.normal(0, 0.25, name = 'bws', shape = (1,))\n",
        "    bs = m.dist.normal(0, 0.25, name = 'bs', shape = (1,))\n",
        "    bw = m.dist.normal(0, 0.25, name = 'bw', shape = (1,))\n",
        "    a = m.dist.normal(0.5, 0.25, name = 'a', shape = (1,))\n",
        "    mu = a + bw*water + bs*shade + bws*water*shade\n",
        "    m.dist.normal(mu, sigma, obs=blooms)\n",
        "\n",
        "# Run mcmc ------------------------------------------------\n",
        "m.fit(model) # Optimize model parameters through MCMC sampling\n",
        "\n",
        "# Summary ------------------------------------------------\n",
        "m.summary()"
      ],
      "id": "0d85ce84",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "### R\n",
        "```R\n",
        "library(BayesianInference)\n",
        "m=importBI(platform='cpu')\n",
        "\n",
        "# Load csv file\n",
        "m$data(m$load$tulips(only_path = T), sep = ''), sep=';')\n",
        "m$scale(list('blooms', 'water', 'shade')) # Normalize\n",
        "m$data_to_model(list('blooms', 'water', 'shade')) # Send to model (convert to jax array)\n",
        "\n",
        "# Define model ------------------------------------------------\n",
        "model <- function(blooms, water,shade){\n",
        "  # Parameter prior distributions\n",
        "  alpha = bi.dist.normal( 0.5, 0.25, name = 'a')\n",
        "  beta1 = bi.dist.normal( 0,  0.25, name = 'b1')\n",
        "  beta2 = bi.dist.normal(  0,  0.25, name = 'b2')\n",
        "  beta_interaction_ = bi.dist.normal(  0, 0.25, name = 'bint')\n",
        "  sigma = bi.dist.normal(0, 50, name = 's')\n",
        "  # Likelihood\n",
        "  m$normal(alpha + beta1*water + beta2*shade + beta_interaction_*water*shade, sigma, obs=blooms)\n",
        "}\n",
        "\n",
        "# Run mcmc ------------------------------------------------\n",
        "m$fit(model) # Optimize model parameters through MCMC sampling\n",
        "\n",
        "# Summary ------------------------------------------------\n",
        "m$summary() # Get posterior distributions\n",
        "\n",
        "\n",
        "```\n",
        "\n",
        "### Julia\n",
        "```julia\n",
        "using BayesianInference\n",
        "\n",
        "# Setup device------------------------------------------------\n",
        "m = importBI(platform=\"cpu\")\n",
        "\n",
        "# Import Data & Data Manipulation ------------------------------------------------\n",
        "# Import\n",
        "data_path = m.load.tulips(only_path = true)\n",
        "m.data(data_path, sep=';')\n",
        "m.scale([\"blooms\", \"water\", \"shade\"]) # Normalize\n",
        "# Define model ------------------------------------------------\n",
        "@BI function model(blooms,shade, water)\n",
        "    sigma = m.dist.exponential(1, name = \"sigma\", shape = (1,))\n",
        "    bws = m.dist.normal(0, 0.25, name = \"bws\", shape = (1,))\n",
        "    bs = m.dist.normal(0, 0.25, name = \"bs\", shape = (1,))\n",
        "    bw = m.dist.normal(0, 0.25, name = \"bw\", shape = (1,))\n",
        "    a = m.dist.normal(0.5, 0.25, name = \"a\", shape = (1,))\n",
        "    mu = a + bw*water + bs*shade + bws*water*shade\n",
        "    m.dist.normal(mu, sigma, obs=blooms)\n",
        "end\n",
        "\n",
        "# Run mcmc ------------------------------------------------\n",
        "m.fit(model)  # Optimize model parameters through MCMC sampling\n",
        "\n",
        "# Summary ------------------------------------------------\n",
        "m.summary() # Get posterior distributions\n",
        "```\n",
        ":::\n",
        "\n",
        "## Mathematical Details\n",
        "## *Frequentist formulation*\n",
        "We model the relationship between the input features ($X_1$ and $X_2$) and the target variable ($Y$) using the following equation:\n",
        "$$\n",
        "ð‘Œ_i = \\alpha + \\beta_1 ð‘‹_{[1,i]} + \\beta_2 ð‘‹_{[2,i]} + \\beta_3 ð‘‹_{[1,i]} ð‘‹_{[2,i]} + \\epsilon_i\n",
        "$$\n",
        "\n",
        "Where:\n",
        "\n",
        "- $Y_i$ is the dependent variable for observation *i*.\n",
        "\n",
        "- $\\alpha$ is the intercept term.\n",
        "\n",
        "- $X_{[1,i]}$ and $X_{[2,i]}$ are the values of the two independent variables for observation *i*.\n",
        "\n",
        "- $\\beta_1$ and $\\beta_2$ are the coefficients for $X_{1}$ and $X_{2}$, respectively, when the other variable has value 0.\n",
        "\n",
        "- $\\beta_3$ is the coefficient which controls the extent to which the coefficient on one variable depends on the value of the other.\n",
        "\n",
        "- $\\epsilon_i$ is the error term, assumed to be independent and normally distributed.\n",
        "\n",
        "\n",
        "### *Bayesian formulation*\n",
        "In the Bayesian formulation, we define each parameter with [<span style=\"color:#0D6EFD\">priors ðŸ›ˆ</span>]{#prior}. We can express the Bayesian regression model as follows:\n",
        "\n",
        "$$\n",
        "Y_i \\sim \\text{Normal}(\\alpha + \\beta_1 X_{[1,i]} + \\beta_2 X_{[2,i]} + \\beta_{3} X_{[1,i]} X_{[2,i]}, \\sigma)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\alpha \\sim \\text{Normal}(0,1)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\beta_1 \\sim \\text{Normal}(0,1)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\beta_2 \\sim \\text{Normal}(0,1)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\beta_{3} \\sim \\text{Normal}(0,1)\n",
        "$$\n",
        "\n",
        "$$\n",
        "\\sigma \\sim \\text{Exponential}(1)\n",
        "$$\n",
        "\n",
        "Where:\n",
        "\n",
        "- $Y_i$ is the dependent variable for observation *i*.\n",
        "\n",
        "- $\\alpha$ is the intercept term, which in this case has a unit-normal prior.\n",
        "\n",
        "- $\\beta_1$ and $\\beta_2$ are the coefficients for $X_{1}$ and $X_{2}$, respectively, when the other variable has value 0.\n",
        "\n",
        "- $\\beta_3$ is the coefficient which controls the extent to which the coefficient on one variable depends on the value of the other.\n",
        "\n",
        "- $X_{[1,i]}$ and $X_{[2,i]}$ are the two values of the independent continuous variables for observation *i*.\n",
        "\n",
        "- $\\sigma$ is a standard deviation parameter, which here has an Exponential prior that constrains it to be positive.\n",
        "\n",
        "## Notes{#Notes}\n",
        "::: callout-note\n",
        "The interaction term equation:\n",
        "$$\n",
        "Y_i \\sim Normal(\\alpha + \\beta_1 X_{[1,i]} + \\beta_2 X_{[2,i]} + \\beta_{3} X_{[1,i]} X_{[2,i]}, \\sigma)\n",
        "$$\n",
        "\n",
        "\n",
        "can be re-written as:\n",
        "$$\n",
        "Y_i \\sim Normal(\\alpha + (\\beta_1 + \\beta_{3} X_{[2,i]}) X_{[1,i]} + \\beta_2 X_{[2,i]}, \\sigma)\n",
        "$$\n",
        "\n",
        "simply by factoring the terms with $X_{[1,i]}$ in them. The result is that the coefficient on $X_{[1,i]}$ is written specifically as a linear regression model of $X_{[2,i]}$.\n",
        ":::\n",
        "\n",
        "## Reference(s)\n",
        "::: {#refs}\n",
        ":::"
      ],
      "id": "39a7cf34"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "/home/sosa/.local/share/jupyter/kernels/python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}