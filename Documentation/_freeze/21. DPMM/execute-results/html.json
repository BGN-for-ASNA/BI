{
  "hash": "2cd70ce47f141f5275b3e446ff4fc76e",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Dirichlet Process Mixture Models\"\ndescription: \"A non-parametric Bayesian clustering method that automatically determines the number of clusters.\"\ncategories: [Clustering, Unsupervised Learning, Non-parametric]\nimage: \"Figures/20.png\"\norder: 24\n---\n\n\n\n\n\n\n## General Principles\n\nTo discover group structures or clusters in data without pre-specifying the number of groups, we can use a **Dirichlet Process Mixture Model (DPMM)** @gershman2012tutorial. This is a [<span style=\"color:#0D6EFD\"> unsupervised clustering method ðŸ›ˆ</span>]{#unsupervised}. Essentially, the model assumes the data is generated from a collection of different Gaussian distributions, and it simultaneously tries to figure out:\n\n1.  **How many clusters (`K`) exist**: Unlike algorithms like K-Means, the DPMM infers the most probable number of clusters directly from the data.\n2.  **The properties of each cluster**: For each inferred cluster, it estimates its location and its spread.\n3.  **The assignment of each data point**: It determines the probability of each data point belonging to each cluster.\n\n## Considerations\n\n::: callout-caution\n-   A DPMM is a Bayesian model ðŸ›ˆ that considers uncertainty in all its parameters. The core idea is to use the Dirichlet Process prior that allows for a potentially infinite number of clusters. In practice, we use a finite approximation where we cap the maximum number of clusters at $K$ and use the [<span style=\"color:#0D6EFD\"> Stick-Breaking Process ðŸ›ˆ</span>]{#stickProcess}.\n\n-   The key parameters and their priors are:\n\n    - **Concentration** $\\alpha$: This single parameter controls the tendency to create new clusters. A low `Î±` favors fewer, larger clusters, while a high `Î±` allows for many smaller clusters. We typically place a `Gamma` prior on $\\alpha$ to learn its value from the data.\n- \n    - **Cluster Weights `w`**: Generated via the Stick-Breaking process from $\\alpha$. These are the probabilities of drawing a data point from any given cluster.\n  \n    - **Cluster Parameters (**$\\mu$, $\\Sigma$): Each potential cluster has a mean $\\mu$ and a covariance matrix $\\Sigma$. If the data have multiple dimensions, we use a multivariate normal distribution (see chapter, [14](14.%20Varying%20slopes.qmd)). However, if the data is one-dimensional, we use a univariate normal distribution.\n\n-   The model is often implemented in its [marginalized form ðŸ›ˆ]{style=\"color:#0D6EFD\"}. Instead of explicitly assigning each data point to a cluster, we integrate out this choice. This creates a smoother probability surface for the inference algorithm to explore, leading to much more efficient computation.\n:::\n\n## Example\n\nBelow is an example of a DPMM implemented in BI. The goal is to cluster a synthetic dataset into its underlying groups. The code first generates data with 4 distinct centers and then applies the DPMM to recover these clusters.\n\n::: {.panel-tabset group=\"language\"}\n## Python\n\n::: {#0e312ed7 .cell execution_count=1}\n``` {.python .cell-code}\nfrom BI import bi, jnp \nfrom sklearn.datasets import make_blobs\nimport numpyro\n\nm = bi(rand_seed = False)\n\n# Generate synthetic data\ndata, true_labels = make_blobs(\n    n_samples=500, centers=8, cluster_std=0.8,\n    center_box=(-10,10), random_state=101\n)\ndata_mean = jnp.mean(data, axis=0)\ndata_std = jnp.std(data, axis=0)*2\n\n#  The model\ndef dpmm(data, K, data_mean, data_std):\n    N, D = data.shape  # Number of features\n\n\n    # 1) stick-breaking weights\n    alpha = m.dist.gamma(1.0, 10.0,name='alpha')\n\n    with m.dist.plate(\"beta_plate\", K - 1):\n        beta = m.dist.beta(1, alpha, name = \"beta\")\n\n    w = numpyro.deterministic(\"w\",m.models.dpmm.mix_weights(beta))\n\n    # 2) component parameters\n    with m.dist.plate(\"components\", K):\n        mu = m.dist.multivariate_normal(loc=data_mean, covariance_matrix=data_std*jnp.eye(D),name='mu')# shape (T, D)        \n        sigma = m.dist.log_normal(0.0, 1.0,shape=(D,),event=1,name='sigma')# shape (T, D)\n        Lcorr = m.dist.lkj_cholesky(dimension=D, concentration=1.0,name='Lcorr')# shape (T, D, D)\n\n        scale_tril = sigma[..., None] * Lcorr  # shape (T, D, D)\n\n    # 3) Latent cluster assignments for each data point\n    m.dist.mixture_same_family(\n        mixing_distribution=m.dist.categorical(probs=w, create_obj=True),\n        component_distribution=m.dist.multivariate_normal(\n            loc=mu, \n            scale_tril=scale_tril, \n            create_obj=True\n        ),\n        obs=data\n    )\n\nm.data_on_model = dict(data=data,K = 10, data_mean=data_mean, data_std=data_std)\nm.fit(dpmm)  # Optimize model parameters through MCMC sampling\nm.plot(X=data,sampler=m.sampler) # Prebuild plot function for GMM\n\n```\n\n::: {.cell-output .cell-output-stdout}\n```\njax.local_device_count 32\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\r  0%|          | 0/1000 [00:00<?, ?it/s]\rwarmup:   0%|          | 1/1000 [00:01<16:58,  1.02s/it, 1 steps of size 2.34e+00. acc. prob=0.00]\rwarmup:   2%|â–         | 15/1000 [00:01<00:57, 17.17it/s, 511 steps of size 2.03e-02. acc. prob=0.67]\rwarmup:   2%|â–         | 21/1000 [00:01<00:43, 22.43it/s, 31 steps of size 3.83e-02. acc. prob=0.71] \rwarmup:   3%|â–Ž         | 27/1000 [00:01<00:40, 23.81it/s, 255 steps of size 1.53e-02. acc. prob=0.71]\rwarmup:   3%|â–Ž         | 32/1000 [00:01<00:38, 25.42it/s, 13 steps of size 1.40e-02. acc. prob=0.72] \rwarmup:   4%|â–         | 42/1000 [00:01<00:25, 37.76it/s, 351 steps of size 3.60e-02. acc. prob=0.75]\rwarmup:   5%|â–Œ         | 50/1000 [00:01<00:21, 44.39it/s, 191 steps of size 4.30e-02. acc. prob=0.75]\rwarmup:   6%|â–Œ         | 60/1000 [00:02<00:16, 55.68it/s, 63 steps of size 4.38e-02. acc. prob=0.76] \rwarmup:   7%|â–‹         | 68/1000 [00:02<00:22, 40.86it/s, 255 steps of size 6.96e-02. acc. prob=0.77]\rwarmup:   8%|â–Š         | 75/1000 [00:02<00:20, 45.13it/s, 255 steps of size 2.96e-02. acc. prob=0.76]\rwarmup:   8%|â–Š         | 81/1000 [00:02<00:19, 46.50it/s, 127 steps of size 6.81e-02. acc. prob=0.77]\rwarmup:   9%|â–Š         | 87/1000 [00:02<00:20, 44.73it/s, 191 steps of size 3.44e-02. acc. prob=0.77]\rwarmup:  10%|â–‰         | 98/1000 [00:02<00:15, 58.66it/s, 63 steps of size 1.79e-02. acc. prob=0.76] \rwarmup:  10%|â–ˆ         | 105/1000 [00:03<00:25, 35.05it/s, 255 steps of size 5.21e-02. acc. prob=0.76]\rwarmup:  11%|â–ˆ         | 111/1000 [00:03<00:25, 34.38it/s, 63 steps of size 8.57e-03. acc. prob=0.76] \rwarmup:  12%|â–ˆâ–        | 116/1000 [00:03<00:30, 29.39it/s, 127 steps of size 2.80e-02. acc. prob=0.76]\rwarmup:  12%|â–ˆâ–        | 120/1000 [00:03<00:28, 30.86it/s, 255 steps of size 5.06e-02. acc. prob=0.77]\rwarmup:  12%|â–ˆâ–Ž        | 125/1000 [00:03<00:29, 29.50it/s, 1023 steps of size 1.66e-02. acc. prob=0.76]\rwarmup:  13%|â–ˆâ–Ž        | 129/1000 [00:04<00:30, 28.99it/s, 63 steps of size 3.14e-02. acc. prob=0.77]  \rwarmup:  13%|â–ˆâ–Ž        | 133/1000 [00:04<00:31, 27.69it/s, 511 steps of size 8.82e-03. acc. prob=0.76]\rwarmup:  14%|â–ˆâ–Ž        | 137/1000 [00:04<00:38, 22.20it/s, 127 steps of size 4.79e-02. acc. prob=0.77]\rwarmup:  14%|â–ˆâ–        | 145/1000 [00:04<00:27, 30.75it/s, 255 steps of size 1.85e-02. acc. prob=0.77]\rwarmup:  15%|â–ˆâ–        | 149/1000 [00:04<00:27, 31.22it/s, 127 steps of size 4.09e-02. acc. prob=0.77]\rwarmup:  16%|â–ˆâ–Œ        | 156/1000 [00:04<00:21, 38.65it/s, 255 steps of size 3.33e-02. acc. prob=0.77]\rwarmup:  16%|â–ˆâ–Œ        | 162/1000 [00:05<00:19, 42.93it/s, 63 steps of size 1.17e-02. acc. prob=0.77] \rwarmup:  17%|â–ˆâ–‹        | 168/1000 [00:05<00:18, 45.78it/s, 95 steps of size 9.15e-03. acc. prob=0.77]\rwarmup:  17%|â–ˆâ–‹        | 173/1000 [00:05<00:22, 36.62it/s, 48 steps of size 1.07e-02. acc. prob=0.77]\rwarmup:  18%|â–ˆâ–Š        | 178/1000 [00:05<00:29, 28.26it/s, 255 steps of size 3.73e-02. acc. prob=0.77]\rwarmup:  18%|â–ˆâ–Š        | 184/1000 [00:05<00:24, 33.12it/s, 255 steps of size 3.85e-02. acc. prob=0.77]\rwarmup:  19%|â–ˆâ–‰        | 188/1000 [00:05<00:24, 33.03it/s, 511 steps of size 1.22e-02. acc. prob=0.77]\rwarmup:  19%|â–ˆâ–‰        | 192/1000 [00:05<00:24, 32.99it/s, 127 steps of size 1.29e-02. acc. prob=0.77]\rwarmup:  20%|â–ˆâ–‰        | 196/1000 [00:06<00:35, 22.65it/s, 511 steps of size 3.14e-02. acc. prob=0.77]\rwarmup:  20%|â–ˆâ–‰        | 199/1000 [00:06<00:45, 17.80it/s, 1023 steps of size 2.44e-02. acc. prob=0.77]\rwarmup:  20%|â–ˆâ–ˆ        | 202/1000 [00:06<00:49, 16.00it/s, 127 steps of size 3.16e-02. acc. prob=0.77] \rwarmup:  20%|â–ˆâ–ˆ        | 204/1000 [00:06<00:49, 16.22it/s, 255 steps of size 6.68e-02. acc. prob=0.78]\rwarmup:  21%|â–ˆâ–ˆ        | 206/1000 [00:07<00:51, 15.54it/s, 1023 steps of size 1.75e-02. acc. prob=0.77]\rwarmup:  21%|â–ˆâ–ˆ        | 208/1000 [00:07<01:00, 13.01it/s, 1023 steps of size 4.27e-02. acc. prob=0.77]\rwarmup:  21%|â–ˆâ–ˆ        | 210/1000 [00:07<01:05, 12.01it/s, 1023 steps of size 1.42e-02. acc. prob=0.77]\rwarmup:  21%|â–ˆâ–ˆ        | 212/1000 [00:07<01:12, 10.85it/s, 1023 steps of size 2.81e-02. acc. prob=0.77]\rwarmup:  21%|â–ˆâ–ˆâ–       | 214/1000 [00:08<01:17, 10.15it/s, 1023 steps of size 7.69e-03. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 216/1000 [00:08<01:21,  9.64it/s, 1023 steps of size 1.78e-02. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 218/1000 [00:08<01:24,  9.27it/s, 1023 steps of size 9.07e-03. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 219/1000 [00:08<01:25,  9.09it/s, 1023 steps of size 1.28e-02. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 220/1000 [00:08<01:27,  8.96it/s, 1023 steps of size 1.97e-02. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 221/1000 [00:08<01:28,  8.81it/s, 1023 steps of size 9.69e-03. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 222/1000 [00:08<01:29,  8.71it/s, 1023 steps of size 1.49e-02. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 223/1000 [00:09<01:30,  8.59it/s, 1023 steps of size 2.17e-02. acc. prob=0.77]\rwarmup:  22%|â–ˆâ–ˆâ–       | 224/1000 [00:09<01:30,  8.54it/s, 1023 steps of size 3.22e-02. acc. prob=0.78]\rwarmup:  22%|â–ˆâ–ˆâ–Ž       | 225/1000 [00:09<01:30,  8.53it/s, 1023 steps of size 4.61e-02. acc. prob=0.78]\rwarmup:  23%|â–ˆâ–ˆâ–Ž       | 226/1000 [00:09<01:30,  8.51it/s, 1023 steps of size 1.27e-02. acc. prob=0.77]\rwarmup:  23%|â–ˆâ–ˆâ–Ž       | 227/1000 [00:09<01:30,  8.52it/s, 1023 steps of size 1.93e-02. acc. prob=0.77]\rwarmup:  23%|â–ˆâ–ˆâ–Ž       | 229/1000 [00:09<01:16, 10.08it/s, 1023 steps of size 2.21e-02. acc. prob=0.77]\rwarmup:  23%|â–ˆâ–ˆâ–Ž       | 232/1000 [00:09<00:51, 14.77it/s, 511 steps of size 3.07e-02. acc. prob=0.78] \rwarmup:  23%|â–ˆâ–ˆâ–Ž       | 234/1000 [00:09<00:53, 14.33it/s, 255 steps of size 3.19e-02. acc. prob=0.78]\rwarmup:  24%|â–ˆâ–ˆâ–Ž       | 236/1000 [00:10<01:05, 11.70it/s, 1023 steps of size 2.39e-02. acc. prob=0.78]\rwarmup:  24%|â–ˆâ–ˆâ–       | 238/1000 [00:10<01:02, 12.23it/s, 511 steps of size 3.71e-02. acc. prob=0.78] \rwarmup:  24%|â–ˆâ–ˆâ–       | 240/1000 [00:10<01:10, 10.84it/s, 1023 steps of size 2.40e-02. acc. prob=0.78]\rwarmup:  24%|â–ˆâ–ˆâ–       | 242/1000 [00:10<01:15, 10.01it/s, 1023 steps of size 3.36e-02. acc. prob=0.78]\rwarmup:  24%|â–ˆâ–ˆâ–       | 244/1000 [00:11<01:19,  9.51it/s, 1023 steps of size 3.97e-02. acc. prob=0.78]\rwarmup:  25%|â–ˆâ–ˆâ–       | 246/1000 [00:11<01:10, 10.71it/s, 1023 steps of size 3.07e-02. acc. prob=0.78]\rwarmup:  25%|â–ˆâ–ˆâ–       | 248/1000 [00:11<01:16,  9.85it/s, 1023 steps of size 3.80e-02. acc. prob=0.78]\rwarmup:  25%|â–ˆâ–ˆâ–Œ       | 250/1000 [00:11<01:20,  9.34it/s, 1023 steps of size 6.00e-02. acc. prob=0.78]\rwarmup:  26%|â–ˆâ–ˆâ–Œ       | 255/1000 [00:11<00:48, 15.43it/s, 255 steps of size 2.50e-02. acc. prob=0.77] \rwarmup:  26%|â–ˆâ–ˆâ–Œ       | 259/1000 [00:11<00:38, 19.11it/s, 255 steps of size 2.92e-02. acc. prob=0.78]\rwarmup:  26%|â–ˆâ–ˆâ–‹       | 263/1000 [00:12<00:35, 20.87it/s, 1023 steps of size 1.04e-02. acc. prob=0.77]\rwarmup:  27%|â–ˆâ–ˆâ–‹       | 266/1000 [00:12<00:32, 22.52it/s, 127 steps of size 2.96e-02. acc. prob=0.78] \rwarmup:  27%|â–ˆâ–ˆâ–‹       | 270/1000 [00:12<00:30, 24.07it/s, 511 steps of size 1.98e-02. acc. prob=0.78]\rwarmup:  28%|â–ˆâ–ˆâ–Š       | 275/1000 [00:12<00:25, 28.60it/s, 255 steps of size 3.63e-02. acc. prob=0.78]\rwarmup:  28%|â–ˆâ–ˆâ–Š       | 280/1000 [00:12<00:24, 29.53it/s, 511 steps of size 1.65e-02. acc. prob=0.78]\rwarmup:  29%|â–ˆâ–ˆâ–Š       | 286/1000 [00:12<00:20, 35.40it/s, 127 steps of size 1.63e-02. acc. prob=0.78]\rwarmup:  29%|â–ˆâ–ˆâ–‰       | 292/1000 [00:12<00:17, 40.91it/s, 255 steps of size 1.95e-02. acc. prob=0.78]\rwarmup:  30%|â–ˆâ–ˆâ–‰       | 297/1000 [00:12<00:17, 40.89it/s, 511 steps of size 1.84e-02. acc. prob=0.78]\rwarmup:  30%|â–ˆâ–ˆâ–ˆ       | 303/1000 [00:13<00:15, 44.74it/s, 127 steps of size 1.89e-02. acc. prob=0.78]\rwarmup:  31%|â–ˆâ–ˆâ–ˆ       | 309/1000 [00:13<00:14, 46.35it/s, 255 steps of size 3.12e-02. acc. prob=0.78]\rwarmup:  32%|â–ˆâ–ˆâ–ˆâ–      | 315/1000 [00:13<00:13, 49.70it/s, 127 steps of size 4.08e-02. acc. prob=0.78]\rwarmup:  32%|â–ˆâ–ˆâ–ˆâ–      | 322/1000 [00:13<00:13, 51.26it/s, 255 steps of size 3.15e-02. acc. prob=0.78]\rwarmup:  33%|â–ˆâ–ˆâ–ˆâ–Ž      | 328/1000 [00:13<00:14, 47.29it/s, 255 steps of size 2.72e-02. acc. prob=0.78]\rwarmup:  33%|â–ˆâ–ˆâ–ˆâ–Ž      | 334/1000 [00:13<00:13, 47.66it/s, 255 steps of size 2.30e-02. acc. prob=0.78]\rwarmup:  34%|â–ˆâ–ˆâ–ˆâ–      | 340/1000 [00:13<00:13, 50.76it/s, 63 steps of size 1.76e-02. acc. prob=0.78] \rwarmup:  35%|â–ˆâ–ˆâ–ˆâ–      | 346/1000 [00:13<00:12, 50.76it/s, 63 steps of size 1.58e-02. acc. prob=0.78]\rwarmup:  35%|â–ˆâ–ˆâ–ˆâ–Œ      | 352/1000 [00:14<00:13, 48.24it/s, 127 steps of size 1.20e-02. acc. prob=0.78]\rwarmup:  36%|â–ˆâ–ˆâ–ˆâ–Œ      | 357/1000 [00:14<00:13, 46.39it/s, 127 steps of size 2.34e-02. acc. prob=0.78]\rwarmup:  36%|â–ˆâ–ˆâ–ˆâ–‹      | 363/1000 [00:14<00:13, 47.96it/s, 255 steps of size 1.97e-02. acc. prob=0.78]\rwarmup:  37%|â–ˆâ–ˆâ–ˆâ–‹      | 368/1000 [00:14<00:15, 40.16it/s, 511 steps of size 1.07e-02. acc. prob=0.78]\rwarmup:  37%|â–ˆâ–ˆâ–ˆâ–‹      | 373/1000 [00:14<00:16, 38.86it/s, 127 steps of size 3.47e-02. acc. prob=0.78]\rwarmup:  38%|â–ˆâ–ˆâ–ˆâ–Š      | 379/1000 [00:14<00:14, 41.59it/s, 255 steps of size 1.84e-02. acc. prob=0.78]\rwarmup:  38%|â–ˆâ–ˆâ–ˆâ–Š      | 385/1000 [00:14<00:13, 44.93it/s, 127 steps of size 5.59e-02. acc. prob=0.78]\rwarmup:  39%|â–ˆâ–ˆâ–ˆâ–‰      | 390/1000 [00:14<00:13, 46.13it/s, 127 steps of size 3.69e-02. acc. prob=0.78]\rwarmup:  40%|â–ˆâ–ˆâ–ˆâ–‰      | 396/1000 [00:15<00:12, 48.92it/s, 255 steps of size 2.02e-02. acc. prob=0.78]\rwarmup:  40%|â–ˆâ–ˆâ–ˆâ–ˆ      | 402/1000 [00:15<00:12, 49.08it/s, 255 steps of size 3.00e-02. acc. prob=0.78]\rwarmup:  41%|â–ˆâ–ˆâ–ˆâ–ˆ      | 407/1000 [00:15<00:12, 48.53it/s, 127 steps of size 3.41e-02. acc. prob=0.78]\rwarmup:  41%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 413/1000 [00:15<00:11, 49.57it/s, 255 steps of size 2.03e-02. acc. prob=0.78]\rwarmup:  42%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 418/1000 [00:15<00:11, 49.65it/s, 255 steps of size 1.83e-02. acc. prob=0.78]\rwarmup:  42%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 423/1000 [00:15<00:11, 48.95it/s, 255 steps of size 3.74e-02. acc. prob=0.78]\rwarmup:  43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 429/1000 [00:15<00:11, 51.07it/s, 255 steps of size 2.85e-02. acc. prob=0.78]\rwarmup:  44%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 436/1000 [00:15<00:10, 54.67it/s, 127 steps of size 1.57e-02. acc. prob=0.78]\rwarmup:  44%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 442/1000 [00:15<00:10, 53.18it/s, 127 steps of size 3.32e-02. acc. prob=0.78]\rwarmup:  45%|â–ˆâ–ˆâ–ˆâ–ˆâ–     | 448/1000 [00:16<00:10, 54.58it/s, 127 steps of size 3.13e-02. acc. prob=0.78]\rwarmup:  46%|â–ˆâ–ˆâ–ˆâ–ˆâ–Œ     | 456/1000 [00:16<00:08, 60.85it/s, 63 steps of size 1.51e-02. acc. prob=0.78] \rwarmup:  46%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 463/1000 [00:16<00:09, 55.64it/s, 255 steps of size 3.95e-02. acc. prob=0.78]\rwarmup:  47%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 469/1000 [00:16<00:09, 55.86it/s, 255 steps of size 3.61e-02. acc. prob=0.78]\rwarmup:  48%|â–ˆâ–ˆâ–ˆâ–ˆâ–Š     | 476/1000 [00:16<00:08, 58.63it/s, 255 steps of size 3.20e-02. acc. prob=0.78]\rwarmup:  48%|â–ˆâ–ˆâ–ˆâ–ˆâ–Š     | 484/1000 [00:16<00:09, 55.77it/s, 511 steps of size 3.93e-02. acc. prob=0.78]\rwarmup:  49%|â–ˆâ–ˆâ–ˆâ–ˆâ–‰     | 494/1000 [00:16<00:07, 66.28it/s, 63 steps of size 6.81e-02. acc. prob=0.78] \rsample:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 504/1000 [00:16<00:06, 74.69it/s, 63 steps of size 4.60e-02. acc. prob=0.55]\rsample:  52%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–    | 517/1000 [00:16<00:05, 89.38it/s, 63 steps of size 4.60e-02. acc. prob=0.86]\rsample:  53%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž    | 527/1000 [00:17<00:05, 90.29it/s, 63 steps of size 4.60e-02. acc. prob=0.86]\rsample:  54%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž    | 537/1000 [00:17<00:05, 92.54it/s, 63 steps of size 4.60e-02. acc. prob=0.88]\rsample:  55%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–    | 547/1000 [00:17<00:05, 88.79it/s, 63 steps of size 4.60e-02. acc. prob=0.88]\rsample:  56%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ    | 557/1000 [00:17<00:05, 78.22it/s, 127 steps of size 4.60e-02. acc. prob=0.86]\rsample:  57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 566/1000 [00:17<00:06, 68.91it/s, 191 steps of size 4.60e-02. acc. prob=0.88]\rsample:  57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 574/1000 [00:17<00:06, 66.60it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  59%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š    | 586/1000 [00:17<00:05, 78.66it/s, 63 steps of size 4.60e-02. acc. prob=0.88] \rsample:  60%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰    | 595/1000 [00:17<00:05, 76.02it/s, 127 steps of size 4.60e-02. acc. prob=0.85]\rsample:  61%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 606/1000 [00:18<00:04, 81.70it/s, 127 steps of size 4.60e-02. acc. prob=0.86]\rsample:  62%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 615/1000 [00:18<00:04, 77.93it/s, 127 steps of size 4.60e-02. acc. prob=0.86]\rsample:  62%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 624/1000 [00:18<00:05, 63.27it/s, 255 steps of size 4.60e-02. acc. prob=0.87]\rsample:  63%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž   | 631/1000 [00:18<00:06, 60.09it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  64%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 639/1000 [00:18<00:05, 63.77it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  65%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–   | 648/1000 [00:18<00:05, 70.10it/s, 63 steps of size 4.60e-02. acc. prob=0.87] \rsample:  66%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ   | 660/1000 [00:18<00:04, 81.27it/s, 63 steps of size 4.60e-02. acc. prob=0.88]\rsample:  67%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹   | 671/1000 [00:18<00:03, 86.89it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  68%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š   | 681/1000 [00:19<00:03, 87.95it/s, 191 steps of size 4.60e-02. acc. prob=0.88]\rsample:  69%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰   | 691/1000 [00:19<00:03, 89.61it/s, 63 steps of size 4.60e-02. acc. prob=0.88] \rsample:  70%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   | 703/1000 [00:19<00:03, 95.95it/s, 63 steps of size 4.60e-02. acc. prob=0.89]\rsample:  71%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 713/1000 [00:19<00:03, 90.05it/s, 127 steps of size 4.60e-02. acc. prob=0.89]\rsample:  72%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 723/1000 [00:19<00:03, 79.81it/s, 127 steps of size 4.60e-02. acc. prob=0.89]\rsample:  73%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž  | 732/1000 [00:19<00:03, 82.11it/s, 63 steps of size 4.60e-02. acc. prob=0.88] \rsample:  74%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 741/1000 [00:19<00:03, 67.08it/s, 447 steps of size 4.60e-02. acc. prob=0.87]\rsample:  75%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 749/1000 [00:20<00:05, 46.33it/s, 383 steps of size 4.60e-02. acc. prob=0.87]\rsample:  76%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  | 755/1000 [00:20<00:06, 37.41it/s, 895 steps of size 4.60e-02. acc. prob=0.87]\rsample:  76%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  | 760/1000 [00:20<00:06, 36.41it/s, 63 steps of size 4.60e-02. acc. prob=0.87] \rsample:  76%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹  | 765/1000 [00:20<00:07, 33.18it/s, 511 steps of size 4.60e-02. acc. prob=0.87]\rsample:  77%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹  | 769/1000 [00:20<00:06, 33.42it/s, 255 steps of size 4.60e-02. acc. prob=0.87]\rsample:  77%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹  | 773/1000 [00:21<00:06, 33.24it/s, 383 steps of size 4.60e-02. acc. prob=0.87]\rsample:  78%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š  | 779/1000 [00:21<00:05, 37.46it/s, 191 steps of size 4.60e-02. acc. prob=0.87]\rsample:  79%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š  | 786/1000 [00:21<00:04, 43.36it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  79%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰  | 793/1000 [00:21<00:04, 48.19it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  80%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  | 802/1000 [00:21<00:03, 54.71it/s, 255 steps of size 4.60e-02. acc. prob=0.87]\rsample:  81%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  | 810/1000 [00:21<00:03, 60.09it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  82%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 819/1000 [00:21<00:02, 65.62it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  83%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž | 826/1000 [00:21<00:02, 63.26it/s, 63 steps of size 4.60e-02. acc. prob=0.87] \rsample:  83%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž | 833/1000 [00:22<00:02, 60.42it/s, 63 steps of size 4.60e-02. acc. prob=0.87]\rsample:  84%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 840/1000 [00:22<00:02, 60.30it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  85%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 850/1000 [00:22<00:02, 69.30it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 860/1000 [00:22<00:01, 75.76it/s, 63 steps of size 4.60e-02. acc. prob=0.87] \rsample:  87%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹ | 869/1000 [00:22<00:01, 78.85it/s, 63 steps of size 4.60e-02. acc. prob=0.88]\rsample:  88%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š | 881/1000 [00:22<00:01, 86.77it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  89%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰ | 890/1000 [00:22<00:01, 86.16it/s, 63 steps of size 4.60e-02. acc. prob=0.88] \rsample:  90%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 900/1000 [00:22<00:01, 86.77it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  91%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 909/1000 [00:22<00:01, 74.57it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  92%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–| 918/1000 [00:23<00:01, 75.83it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  93%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž| 927/1000 [00:23<00:00, 78.17it/s, 127 steps of size 4.60e-02. acc. prob=0.88]\rsample:  94%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž| 936/1000 [00:23<00:00, 81.15it/s, 63 steps of size 4.60e-02. acc. prob=0.88] \rsample:  95%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–| 946/1000 [00:23<00:00, 84.63it/s, 63 steps of size 4.60e-02. acc. prob=0.88]\rsample:  96%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ| 955/1000 [00:23<00:00, 79.92it/s, 63 steps of size 4.60e-02. acc. prob=0.88]\rsample:  96%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹| 964/1000 [00:23<00:00, 74.27it/s, 127 steps of size 4.60e-02. acc. prob=0.87]\rsample:  97%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹| 972/1000 [00:23<00:00, 74.07it/s, 63 steps of size 4.60e-02. acc. prob=0.86] \rsample:  98%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š| 981/1000 [00:23<00:00, 77.91it/s, 127 steps of size 4.60e-02. acc. prob=0.86]\rsample:  99%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰| 992/1000 [00:23<00:00, 84.50it/s, 127 steps of size 4.60e-02. acc. prob=0.86]\rsample: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:24<00:00, 41.39it/s, 63 steps of size 4.60e-02. acc. prob=0.87]\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nModel found 8 clusters.\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](21. DPMM_files/figure-html/cell-2-output-4.png){width=827 height=523}\n:::\n:::\n\n\n## R\n\n``` r\n\n```\n![](travaux-routiers.png){fig-align=\"center\"}\n\n## Julia\n```julia\nusing BayesianInference\nusing PythonCall\nnumpyro = pyimport(\"numpyro\")\n\nm = importBI(rand_seed = false)\n\n# 1. Generate Data\nsk_datasets = pyimport(\"sklearn.datasets\")\noutput = sk_datasets.make_blobs(n_samples=500, centers=8, cluster_std=0.8, center_box=(-10, 10), random_state=101)\ndata = output[0]\ndata_mean = jnp.mean(data, axis=0)\ndata_std = jnp.std(data, axis=0) * 2\nm.data_on_model = pydict(data=data, K=10, data_mean = data_mean, data_std = data_std)\n\n\n@BI function dpmm(data, K, data_mean , data_std)\n    N, D = data.shape \n\n    alpha = m.dist.gamma(1.0, 10.0, name=\"alpha\")\n\n    beta = pywith(m.dist.plate(\"beta_plate\", K - 1)) do _\n        m.dist.beta(1, alpha, name = \"beta\")\n    end\n\n    w = numpyro.deterministic(\"w\", m.models.dpmm.mix_weights(beta))\n\n    mu, scale_tril = pywith(m.dist.plate(\"components\", K)) do _\n        mu_val = m.dist.multivariate_normal(\n            loc=data_mean, \n            covariance_matrix=data_std * jnp.eye(D),\n            name=\"mu\"\n        )\n        \n        sigma = m.dist.log_normal(0.0, 1.0, shape=(D,), event=1, name=\"sigma\")\n        Lcorr = m.dist.lkj_cholesky(dimension=D, concentration=1.0, name=\"Lcorr\")\n        scale_tril_inner = jnp.expand_dims(sigma, -1) * Lcorr\n        (mu_val, scale_tril_inner)\n    end\n    \n    m.dist.mixture_same_family(\n        mixing_distribution=m.dist.categorical(probs=w, create_obj=true),\n        component_distribution=m.dist.multivariate_normal(\n            loc=mu, \n            scale_tril=scale_tril, \n            create_obj=true\n        ),\n        obs=data\n    )\nend\n\n# 4. Run\n\nm.fit(dpmm) \n\n@pyplot m.models.dpmm.plot_dpmm(m.data_on_model[\"data\"], m.sampler)\n```\n:::\n\n## Mathematical Details\n\nThe process involves two keys submodels. The first, aims to identify the location and scale of $K$ potential clusters. The second, aims to identify which cluster is most likely to have generated a given data point. \n\n$$\n\\begin{aligned}\n\\begin{pmatrix}\nY_{i,1} \\\\\n\\vdots \\\\\nY_{i,D}\n\\end{pmatrix}\n&\\sim\n\\text{MVN}\\!\\left(\n\\begin{pmatrix}\n\\mu_{z_i,1} \\\\\n\\vdots \\\\\n\\mu_{z_i,D}\n\\end{pmatrix},\n\\,\n\\Sigma_{z_i}\n\\right) \\\\\n\\\\\n\\begin{pmatrix}\n\\mu_{k,1} \\\\\n\\vdots \\\\\n\\mu_{k,D}\n\\end{pmatrix}\n&\\sim\n\\text{MVN}\\!\\left(\n\\begin{pmatrix}\nA_{1} \\\\\n\\vdots \\\\\nA_{D}\n\\end{pmatrix},\n\\, B\n\\right) \\\\\n\\\\\n\\Sigma_k &= \\text{Diag}(\\sigma_k) \\Omega_k  \\text{Diag}(\\sigma_k) \\\\\n\\\\\n\\sigma_{[k,d]} &\\sim \\text{HalfCauchy}(1) \\\\\n\\\\\n\\Omega_k &\\sim \\text{LKJ}(2) \\\\\n\\\\\nz_{i} &\\sim \\text{Categorical}(\\pi) \\\\\n\\\\\n\\pi_{i}(\\beta_{1:K})  &=  \\beta_i \\prod_{j<K} (1-\\beta_j) \\\\\n\\\\\n\\beta_k &\\sim \\text{Beta}(1, \\alpha) \\\\\n\\\\\n\\alpha &\\sim \\text{Gamma}(1, 10) \\\\\n\\end{aligned}\n$$\n\nWhere : \n\n*   $\\begin{pmatrix} Y_{[i,1]} \\\\ \\vdots \\\\ Y_{[i,D]} \\end{pmatrix}$ is the $i$-th observation of a D-dimensional data array.\n\n*   $\\begin{pmatrix}\\mu_{[k,1]} \\\\ \\vdots \\\\ \\mu_{[k,D]}\\end{pmatrix}$ is the $k$-th parameter vector of dimension D.\n\n*   $\\begin{pmatrix} A_{1} \\\\ \\vdots \\\\ A_{D} \\end{pmatrix}$ is a prior for the  mean vector as derived from mean of the raw data. \n\n*   $B$ is the prior covariance of the cluster means, and is setup as a diagonal matrix with 0.1 along the diagonal.\n\n*   $\\Sigma_k$ is the DxD covariance matrix of the $k$-th cluster (it is composed from $\\sigma_k$ and $\\Omega_k$).\n\n*  $\\text{Diag}(\\sigma_k)$ is a diagonal matrix whose diagonal entries are the standard deviations:\n  $$\n  \\text{Diag}(\\sigma_k) =\n  \\begin{pmatrix}\n  \\sigma_{[k,1]} & 0 & \\cdots & 0 \\\\\n  0 & \\sigma_{[k,2]} &        & \\vdots \\\\\n  \\vdots &        & \\ddots & 0 \\\\\n  0 & \\cdots & 0 & \\sigma_{[k,D]}\n  \\end{pmatrix}.\n  $$\n\n*   $\\sigma_{k}$ is a $D$-vector of standard deviations for the $k$-th cluster where each element, $d$, has a half-cauchy prior.\n\n*   $\\Omega_k$ is a correlation matrix for the $k$-th cluster.\n\n*   $z_i$ is a latent variable that maps observation $i$ to cluster $k$.\n\n*   $\\pi$ is a vector of $K$ cluster weights, some of which may be close to zero if the predicted number of clusters is less than the maximum number of clusters.\n  \n*   $\\beta_k$: The set of $K$ Beta-distributed random variables used in the stick-breaking process to construct the mixture weights.\n\n*   $\\alpha$: The concentration parameter, controlling the effective number of clusters. \n\n\n## Notes\n\n::: callout-note\n* The primary advantage of the DPMM is the **automatic inference of the number of clusters**. The posterior distribution of the weights `w` reveals which components are \"active\", giving a probabilistic estimate of `K`.\n\n* Prior $\\alpha$ strongly influence the predicted number of clusters. Below are examples of this relationship:\n\n| Shape | Rate | Behavior |\n|:---:|:---:|:---:|\n| 1     | 15    | Forces very few clusters |\n| 5     | 1     | Encourages many small clusters |\n| 10    | 2     | Same mean, less variance |\n| 2     | 0.5   | Moderately many clusters |\n| 15    | 1     | Explosive prior cluster count |\n: Impact of Gamma Prior Hyperparameters on Cluster Counts {tbl-colwidths=\"[10,10,15,25,40]\"}\n:::\n\n## Reference(s)\n\nhttps://en.wikipedia.org/wiki/Dirichlet_process\nhttps://pyro.ai/examples/dirichlet_process_mixture.html\n\n",
    "supporting": [
      "21. DPMM_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}