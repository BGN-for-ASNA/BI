{
  "hash": "d9cea00b462c8bad3f4e06489a70d75a",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Poisson Model\"\ndescription: \"Modeling count data, such as the number of events occurring in a fixed interval of time or space.\"\ncategories: [Regression, Count Data, GLM]\nimage: \"Figures/7.png\"\norder: 8\n---\n\n\n## General Principles\nTo model the relationship between a count outcome variableâ€”e.g., counts of events occurring in a fixed interval of time or spaceâ€”and one or more independent variables, we can use the _Poisson model_.\n\nThis is a special shape of the binomial distribution; it is useful because it models binomial events for which the number of trials $n$ is unknown or uncountably large.\n\n\n## Considerations\n::: callout-caution\n- We have the same considerations as for [Regression for a continuous variable](1.&#32;Linear&#32;Regression&#32;for&#32;continuous&#32;variable.qmd).\n\n- We have the second [<span style=\"color:#0D6EFD\">link function ðŸ›ˆ</span>]{#linkF}: _log_. The _log_ link ensures that _Î»_ is always positive.\n\n- The dependent variable in a Poisson regression must be a non-negative count.\n\n- To invert the log link function and linearly model the relationship between the predictor variables and the log of the mean rate parameter, we can apply the $exponential$ function (see comment in code).\n\n- A key assumption of the $Poisson$ distribution is that the mean and variance of the count variable are equal. If the variance is greater than the mean, a condition known as overdispersion, a [Gamma-Poisson model](8.&#32;Gamma-Poisson.qmd) might be more appropriate.\n\n\n:::\n\n## Example\nBelow is an example code snippet demonstrating a Bayesian Poisson model using the Bayesian Inference (BI) package. Data consist of:\n\n1) A continuous dependent variable *total_tools*, which represents the number of tools produced by a civilization.\n\n2) A continuous independent variable *population* representing population size.\n\n3) A categorical independent variable *cid* representing different civilizations.\n\nThe goal is to estimate the production of tools based on population size, accounting for each civilization. This example is based on @mcelreath2018statistical.\n\n\n::: {.panel-tabset group=\"language\"}\n### Python\n\n::: {#c090b4fb .cell execution_count=1}\n``` {.python .cell-code}\nfrom BI import bi\nimport jax.numpy as jnp\n# Setup device------------------------------------------------\nm = bi(platform='cpu')\n\n# import data ------------------------------------------------\n# Import\nfrom importlib.resources import files\ndata_path = files('BI.resources.data') / 'Kline.csv'\nm.data(data_path, sep=';')\nm.scale(['population'])\nm.df[\"cid\"] = (m.df.contact == \"high\").astype(int)\n#m.data_to_model(['total_tools', 'population', 'cid'])\ndef model(cid, population, total_tools):\n    a = m.dist.normal(3, 0.5, shape= (2,), name='a')\n    b = m.dist.normal(0, 0.2, shape=(2,), name='b')\n    l = jnp.exp(a[cid] + b[cid]*population)\n    m.dist.poisson(l, obs=total_tools)\n\n# Run sampler ------------------------------------------------\nm.fit(model)\n\n# Diagnostic ------------------------------------------------\nm.summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\njax.local_device_count 16\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\r  0%|          | 0/1000 [00:00<?, ?it/s]\rwarmup:   0%|          | 1/1000 [00:01<27:09,  1.63s/it, 1 steps of size 2.34e+00. acc. prob=0.00]\rwarmup:  12%|â–ˆâ–        | 120/1000 [00:01<00:09, 96.40it/s, 7 steps of size 9.26e-01. acc. prob=0.78]\rwarmup:  25%|â–ˆâ–ˆâ–       | 246/1000 [00:01<00:03, 216.36it/s, 7 steps of size 9.24e-01. acc. prob=0.78]\rwarmup:  36%|â–ˆâ–ˆâ–ˆâ–Œ      | 359/1000 [00:01<00:01, 333.32it/s, 7 steps of size 4.57e-01. acc. prob=0.78]\rwarmup:  49%|â–ˆâ–ˆâ–ˆâ–ˆâ–‰     | 491/1000 [00:02<00:01, 485.33it/s, 3 steps of size 1.18e+00. acc. prob=0.79]\rsample:  61%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 606/1000 [00:02<00:00, 605.52it/s, 15 steps of size 5.19e-01. acc. prob=0.91]\rsample:  72%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–  | 722/1000 [00:02<00:00, 718.77it/s, 7 steps of size 5.19e-01. acc. prob=0.91] \rsample:  86%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 861/1000 [00:02<00:00, 870.82it/s, 7 steps of size 5.19e-01. acc. prob=0.92]\rsample:  99%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰| 990/1000 [00:02<00:00, 973.26it/s, 7 steps of size 5.19e-01. acc. prob=0.92]\rsample: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:02<00:00, 409.26it/s, 7 steps of size 5.19e-01. acc. prob=0.92]\narviz - WARNING - Shape validation failed: input_shape: (1, 500), minimum_shape: (chains=2, draws=4)\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=1}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>mean</th>\n      <th>sd</th>\n      <th>hdi_5.5%</th>\n      <th>hdi_94.5%</th>\n      <th>mcse_mean</th>\n      <th>mcse_sd</th>\n      <th>ess_bulk</th>\n      <th>ess_tail</th>\n      <th>r_hat</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>a[0]</th>\n      <td>3.22</td>\n      <td>0.09</td>\n      <td>3.07</td>\n      <td>3.37</td>\n      <td>0.01</td>\n      <td>0.00</td>\n      <td>289.74</td>\n      <td>380.43</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>a[1]</th>\n      <td>3.63</td>\n      <td>0.09</td>\n      <td>3.50</td>\n      <td>3.80</td>\n      <td>0.00</td>\n      <td>0.01</td>\n      <td>444.71</td>\n      <td>169.36</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>b[0]</th>\n      <td>0.35</td>\n      <td>0.05</td>\n      <td>0.27</td>\n      <td>0.42</td>\n      <td>0.00</td>\n      <td>0.00</td>\n      <td>323.06</td>\n      <td>445.13</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>b[1]</th>\n      <td>0.04</td>\n      <td>0.20</td>\n      <td>-0.26</td>\n      <td>0.36</td>\n      <td>0.01</td>\n      <td>0.01</td>\n      <td>396.58</td>\n      <td>324.48</td>\n      <td>NaN</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n### R\n```R\nlibrary(BI)\n\n# Setup platform------------------------------------------------\nm=importbi(platform='cpu')\n\n# import data ------------------------------------------------\nm$data(paste(system.file(package = \"BI\"),\"/data/Kline.csv\", sep = ''), sep=';')\nm$scale(list('population'))# Scale\nm$df[\"cid\"] =  as.integer(ifelse(m$df$contact == \"high\", 1, 0)) # Manipulate\nm$data_to_model(list('total_tools', 'population', 'cid' )) # Send to model (convert to jax array)\n\n# Define model ------------------------------------------------\nmodel <- function(total_tools, population, cid){\n  # Parameter prior distributions\n  alpha = bi.dist.normal(3, 0.5, name='alpha', shape = c(2))\n  beta = bi.dist.normal(0, 0.2, name='beta', shape = c(2))\n  l = jnp$exp(alpha[cid] + beta[cid]*population)\n  # Likelihood\n  m.dist.poisson(l, obs=total_tools)\n}\n\n# Run MCMC ------------------------------------------------\nm$fit(model) # Optimize model parameters through MCMC sampling\n\n# Summary ------------------------------------------------\nm$summary() # Get posterior distribution\n\n```\n:::\n\n## Mathematical Details\n\nIn the Bayesian formulation, we define each parameter with [<span style=\"color:#0D6EFD\">priors ðŸ›ˆ</span>]{#prior}. We can express the Bayesian regression model accounting for prior distributions as follows:\n\n$$\nY_i \\sim \\text{Poisson}(\\lambda_i)\n$$\n\n$$\nlog(\\lambda_i) = \\alpha + \\beta X_i\n$$\n\n$$\n\\alpha \\sim \\text{Normal}(0, 1)\n$$\n\n$$\n\\beta \\sim \\text{Normal}(0, 1)\n$$\n\nWhere:\n\n- $Y_i$ is the dependent variable for observation *i*.\n\n- $\\log()$ is the **log link function**. This function links the log of the mean of the response variable, $\\lambda_i$, to the linear predictor, $\\alpha + \\beta X_i$. The logarithm is the canonical link function for the Poisson distribution. It ensures that the predicted mean, $\\lambda_i = \\exp(\\alpha + \\beta X_i)$, will always be positive, as required for a Poisson rate parameter. \n\n- $\\alpha$ and $\\beta$ are the intercept and regression coefficient, respectively, with their associated prior distributions. \n\n- $X_i$ is the value of the independent variable for observation *i*.\n\n## Notes\n::: callout-note\n\n- We can apply multiple variables similarly to [chapter 2](2.&#32;Multiple&#32;continuous&#32;variables.qmd).\n\n- We can apply interaction terms similarly to [chapter 3](3.&#32;Interaction&#32;between&#32;continuous&#32;variables.qmd).\n\n- We can apply categorical variables similarly to [chapter 4](4.&#32;Categorical&#32;variable.qmd).\n\n\n## Reference(s)\n::: {#refs}\n:::\n\n",
    "supporting": [
      "7. Poisson model_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}