{
  "hash": "182b406990942d4c86daea6aab12ad4b",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Gamma-Poisson Model\"\ndescription: \"An extension of the Poisson model for count data that exhibits overdispersion.\"\ncategories: [Regression, Count Data, GLM]\nimage: \"Figures/8.png\"\norder: 10\n---\n\n\n\n\n\n\n## General Principles \nTo model the relationship between a count outcome variable and one or more independent variables with [<span style=\"color:#0D6EFD\">overdispersion ðŸ›ˆ</span>]{#overdispersion}, we can use the _Negative Binomial model_. \n\n## Considerations\n::: callout-caution \n- We have the same considerations as for the [Poisson model](7.&#32;Poisson&#32;model.qmd).\n  \n- Overdispersion is handled because the Gamma-Poisson model assumes that each Poisson count observation has its own rate. This is an additional parameter specified in the model (in the code, it is `log_days`).\n:::\n \n## Example\nBelow is an example code snippet demonstrating a Bayesian Gamma-Poisson model using the Bayesian Inference (BI) package. \n\n::: {.panel-tabset group=\"language\"}\n### Python\n\n::: {#818ade7a .cell execution_count=1}\n``` {.python .cell-code}\nfrom BI import bi, jnp\n\n# Setup device ------------------------------------------------\nm = bi(platform='cpu') # Import\n\n# Import Data & Data Manipulation ------------------------------------------------\n# Import\nfrom importlib.resources import files\ndata_path =  m.load.sim_gamma_poisson(only_path=True)\nm.data(data_path, sep=',') \nm.data_to_model(['log_days', 'monastery', 'y']) # Send to model (convert to jax array)\n\n# Define model ------------------------------------------------\ndef model(log_days, monastery, y):\n    a = m.dist.normal(0, 1, name = 'a', shape=(1,))\n    b = m.dist.normal(0, 1, name = 'b', shape=(1,))\n    phi = m.dist.exponential(1, name = 'phi', shape=(1,))\n    mu = jnp.exp(log_days + a + b * monastery)\n    Lambda =  m.dist.gamma(rate = mu*phi, concentration = phi, name = 'Lambda')\n    m.dist.poisson(rate = Lambda, obs=y)\n# Run MCMC ------------------------------------------------\nm.fit(model) # Optimize model parameters through MCMC sampling\n\n# Summary ------------------------------------------------\nm.summary() # Get posterior distributions\n```\n\n::: {.cell-output .cell-output-stdout}\n```\njax.local_device_count 32\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\r  0%|          | 0/1000 [00:00<?, ?it/s]\rwarmup:   0%|          | 1/1000 [00:00<09:22,  1.78it/s, 1 steps of size 2.34e+00. acc. prob=0.00]\rwarmup:   1%|          | 10/1000 [00:00<00:53, 18.48it/s, 511 steps of size 9.70e-03. acc. prob=0.58]\rwarmup:   2%|â–         | 16/1000 [00:00<00:36, 27.01it/s, 255 steps of size 1.31e-02. acc. prob=0.67]\rwarmup:   2%|â–         | 22/1000 [00:00<00:28, 34.33it/s, 1023 steps of size 4.12e-03. acc. prob=0.68]\rwarmup:   3%|â–Ž         | 28/1000 [00:01<00:28, 34.61it/s, 255 steps of size 9.52e-03. acc. prob=0.71] \rwarmup:   3%|â–Ž         | 33/1000 [00:01<00:27, 35.78it/s, 511 steps of size 5.53e-03. acc. prob=0.71]\rwarmup:   4%|â–         | 40/1000 [00:01<00:23, 41.06it/s, 511 steps of size 4.30e-03. acc. prob=0.72]\rwarmup:   5%|â–         | 47/1000 [00:01<00:19, 47.88it/s, 41 steps of size 1.72e-03. acc. prob=0.72] \rwarmup:   5%|â–Œ         | 53/1000 [00:01<00:20, 46.74it/s, 511 steps of size 3.09e-03. acc. prob=0.73]\rwarmup:   6%|â–Œ         | 59/1000 [00:01<00:19, 48.20it/s, 511 steps of size 4.35e-03. acc. prob=0.74]\rwarmup:   7%|â–‹         | 68/1000 [00:01<00:16, 57.29it/s, 255 steps of size 6.12e-03. acc. prob=0.75]\rwarmup:   8%|â–Š         | 75/1000 [00:01<00:16, 57.52it/s, 511 steps of size 4.81e-03. acc. prob=0.75]\rwarmup:   8%|â–Š         | 82/1000 [00:02<00:15, 59.87it/s, 127 steps of size 8.54e-03. acc. prob=0.76]\rwarmup:   9%|â–‰         | 89/1000 [00:02<00:15, 58.96it/s, 255 steps of size 2.71e-03. acc. prob=0.75]\rwarmup:  10%|â–‰         | 96/1000 [00:02<00:16, 54.85it/s, 255 steps of size 7.02e-03. acc. prob=0.76]\rwarmup:  10%|â–ˆ         | 102/1000 [00:02<00:16, 53.45it/s, 63 steps of size 1.31e-01. acc. prob=0.76]\rwarmup:  13%|â–ˆâ–Ž        | 132/1000 [00:02<00:07, 116.39it/s, 63 steps of size 1.39e-01. acc. prob=0.77]\rwarmup:  16%|â–ˆâ–‹        | 165/1000 [00:02<00:04, 168.90it/s, 127 steps of size 6.12e-02. acc. prob=0.77]\rwarmup:  20%|â–ˆâ–‰        | 196/1000 [00:02<00:03, 206.33it/s, 31 steps of size 2.21e-01. acc. prob=0.78] \rwarmup:  22%|â–ˆâ–ˆâ–       | 224/1000 [00:02<00:03, 225.30it/s, 31 steps of size 2.83e-01. acc. prob=0.78]\rwarmup:  26%|â–ˆâ–ˆâ–Œ       | 259/1000 [00:02<00:02, 260.20it/s, 15 steps of size 1.70e-01. acc. prob=0.78]\rwarmup:  29%|â–ˆâ–ˆâ–‰       | 289/1000 [00:03<00:02, 268.15it/s, 63 steps of size 1.10e-01. acc. prob=0.78]\rwarmup:  32%|â–ˆâ–ˆâ–ˆâ–Ž      | 325/1000 [00:03<00:02, 292.59it/s, 31 steps of size 1.38e-01. acc. prob=0.78]\rwarmup:  36%|â–ˆâ–ˆâ–ˆâ–Œ      | 359/1000 [00:03<00:02, 305.44it/s, 31 steps of size 9.82e-02. acc. prob=0.78]\rwarmup:  39%|â–ˆâ–ˆâ–ˆâ–‰      | 392/1000 [00:03<00:01, 310.77it/s, 31 steps of size 2.64e-01. acc. prob=0.78]\rwarmup:  43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 427/1000 [00:03<00:01, 321.13it/s, 31 steps of size 1.72e-01. acc. prob=0.78]\rwarmup:  46%|â–ˆâ–ˆâ–ˆâ–ˆâ–Œ     | 460/1000 [00:03<00:01, 318.83it/s, 31 steps of size 1.27e-01. acc. prob=0.78]\rwarmup:  49%|â–ˆâ–ˆâ–ˆâ–ˆâ–‰     | 493/1000 [00:03<00:01, 306.48it/s, 31 steps of size 1.87e-01. acc. prob=0.78]\rsample:  52%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–    | 524/1000 [00:03<00:01, 268.35it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  55%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ    | 552/1000 [00:03<00:01, 265.32it/s, 31 steps of size 1.31e-01. acc. prob=0.90]\rsample:  58%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š    | 580/1000 [00:04<00:01, 259.08it/s, 31 steps of size 1.31e-01. acc. prob=0.88]\rsample:  61%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 607/1000 [00:04<00:01, 247.37it/s, 31 steps of size 1.31e-01. acc. prob=0.88]\rsample:  63%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž   | 633/1000 [00:04<00:01, 243.73it/s, 31 steps of size 1.31e-01. acc. prob=0.88]\rsample:  66%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹   | 663/1000 [00:04<00:01, 258.17it/s, 31 steps of size 1.31e-01. acc. prob=0.88]\rsample:  70%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‰   | 696/1000 [00:04<00:01, 276.84it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  73%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž  | 732/1000 [00:04<00:00, 299.13it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  77%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹  | 767/1000 [00:04<00:00, 312.32it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  80%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  | 804/1000 [00:04<00:00, 326.80it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  84%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ– | 840/1000 [00:04<00:00, 335.72it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  87%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹ | 874/1000 [00:04<00:00, 336.00it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  91%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 911/1000 [00:05<00:00, 344.09it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  95%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–| 946/1000 [00:05<00:00, 345.12it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample:  98%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š| 981/1000 [00:05<00:00, 342.81it/s, 31 steps of size 1.31e-01. acc. prob=0.89]\rsample: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1000/1000 [00:05<00:00, 187.28it/s, 31 steps of size 1.31e-01. acc. prob=0.88]\narviz - WARNING - Shape validation failed: input_shape: (1, 500), minimum_shape: (chains=2, draws=4)\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=1}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>mean</th>\n      <th>sd</th>\n      <th>hdi_5.5%</th>\n      <th>hdi_94.5%</th>\n      <th>mcse_mean</th>\n      <th>mcse_sd</th>\n      <th>ess_bulk</th>\n      <th>ess_tail</th>\n      <th>r_hat</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>Lambda[0]</th>\n      <td>1.56</td>\n      <td>0.38</td>\n      <td>0.97</td>\n      <td>2.11</td>\n      <td>0.01</td>\n      <td>0.02</td>\n      <td>793.43</td>\n      <td>367.44</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>Lambda[1]</th>\n      <td>1.51</td>\n      <td>0.36</td>\n      <td>1.02</td>\n      <td>2.12</td>\n      <td>0.01</td>\n      <td>0.02</td>\n      <td>877.99</td>\n      <td>293.31</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>Lambda[2]</th>\n      <td>1.58</td>\n      <td>0.38</td>\n      <td>0.93</td>\n      <td>2.12</td>\n      <td>0.01</td>\n      <td>0.02</td>\n      <td>741.78</td>\n      <td>372.31</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>Lambda[3]</th>\n      <td>1.40</td>\n      <td>0.34</td>\n      <td>0.93</td>\n      <td>1.96</td>\n      <td>0.01</td>\n      <td>0.02</td>\n      <td>937.17</td>\n      <td>277.70</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>Lambda[4]</th>\n      <td>1.47</td>\n      <td>0.37</td>\n      <td>0.89</td>\n      <td>2.00</td>\n      <td>0.02</td>\n      <td>0.02</td>\n      <td>507.60</td>\n      <td>428.36</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>Lambda[3398]</th>\n      <td>3.53</td>\n      <td>0.77</td>\n      <td>2.43</td>\n      <td>4.67</td>\n      <td>0.03</td>\n      <td>0.04</td>\n      <td>914.23</td>\n      <td>399.13</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>Lambda[3399]</th>\n      <td>3.68</td>\n      <td>0.79</td>\n      <td>2.56</td>\n      <td>5.06</td>\n      <td>0.03</td>\n      <td>0.06</td>\n      <td>727.90</td>\n      <td>235.65</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>a[0]</th>\n      <td>-0.42</td>\n      <td>0.01</td>\n      <td>-0.45</td>\n      <td>-0.40</td>\n      <td>0.00</td>\n      <td>0.00</td>\n      <td>40.06</td>\n      <td>101.97</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>b[0]</th>\n      <td>-2.75</td>\n      <td>0.03</td>\n      <td>-2.81</td>\n      <td>-2.71</td>\n      <td>0.00</td>\n      <td>0.00</td>\n      <td>57.05</td>\n      <td>188.62</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>phi[0]</th>\n      <td>17.63</td>\n      <td>1.91</td>\n      <td>14.32</td>\n      <td>20.23</td>\n      <td>0.56</td>\n      <td>0.18</td>\n      <td>12.25</td>\n      <td>44.88</td>\n      <td>NaN</td>\n    </tr>\n  </tbody>\n</table>\n<p>3403 rows Ã— 9 columns</p>\n</div>\n```\n:::\n:::\n\n\n### R\n```R\nlibrary(BayesianInference)\n\n# Setup platform------------------------------------------------\nm=importBI(platform='cpu')\n\n# Import data ------------------------------------------------\nm$data(m$load$sim_gamma_poisson(only_path=T), sep = '')\nm$data_to_model(list('log_days', 'monastery', 'y' )) # Send to model (convert to jax array)\n\n# Define model ------------------------------------------------\nmodel <- function(log_days, monastery, y){\n  # Parameter prior distributions\n  alpha = bi.dist.normal(0, 1, name='alpha', shape=c(1))\n  beta = bi.dist.normal(0, 1, name='beta', shape=c(1))\n  phi = bi.dist.exponential(1, name='phi', shape=c(1))\n  mu = jnp$exp(log_days + alpha + beta * monastery)\n  Lambda =  bi.dist.gamma(rate = mu*phi, concentration = phi, name = 'Lambda')\n  # Likelihood\n  bi.dist.poisson(rate=Lambda, obs=y)\n}\n# Run MCMC ------------------------------------------------\nm$fit(model) # Optimize model parameters through MCMC sampling\n\n# Summary ------------------------------------------------\nm$summary() # Get posterior distributions\n\n\n\n```\n:::\n\n## Mathematical Details\n### *Bayesian model*\nIn the Bayesian formulation, we define each parameter with [<span style=\"color:#0D6EFD\">priors ðŸ›ˆ</span>]{#prior}. We can express the Bayesian regression model accounting for prior distributions as follows:\n\n$$\nY_i \\sim \\text{Poisson}(\\lambda_i)\n$$\n\n$$\n\\lambda_i \\sim \\text{Gamma}(\\mu_i \\phi, \\phi)\n$$\n\n$$\n\\log(\\mu_i) = \\text{rates}_i + \\alpha + \\beta X_i\n$$\n\n$$\n\\alpha \\sim \\text{Normal}(0,1)\n$$\n\n$$\n\\beta \\sim \\text{Normal}(0,1)\n$$\n\n$$\n\\phi \\sim \\text{Exponential}(1)\n$$\n\nWhere:\n\n- $Y_i$ is the dependent variable for observation *i*. \n  \n- $\\lambda_i$ is the rate parameter of the Poisson distribution for observation *i*, assuming that each Poisson count observation has its own $rate_i$.\n  \n- $\\mu_i$ is the mean rate parameter.\n- \n- $\\phi$ controls the level of overdispersion in the rates.\n  \n- $\\alpha$ is the intercept term.\n  \n- $\\beta$ is the regression coefficient.\n  \n- $X_i$ is the value of the predictor variable for observation *i*.\n\n\n## Notes\n\n::: callout-note \n- We can apply multiple variables similarly as in [chapter 2](2.&#32;Multiple&#32;continuous&#32;variables.qmd).\n\n- We can apply interaction terms similarly as in [chapter 3](3.&#32;Interaction&#32;between&#32;Continuous&#32;Variables.qmd).\n\n- We can apply categorical variables similarly as in [chapter 4](4.&#32;Categorical&#32;variable.qmd).\n:::\n\n## Reference(s)\n\n",
    "supporting": [
      "8. Gamma-Poisson_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}