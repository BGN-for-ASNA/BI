{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Latent Variable Models ðŸš§\"\n",
        "description: \"Models that relate a set of observable variables to a set of unobserved (latent) variables.\"\n",
        "categories: [Structural Equation Modeling, Factor Analysis]\n",
        "image: \"Figures/25.png\"\n",
        "order: 21\n",
        "---\n",
        "\n",
        "## General Principles\n",
        "\n",
        "In some scenarios, the observed data does not directly reflect the underlying structure or factors influencing the outcome. Instead, _latent variables_â€”variables that are not directly observed but are inferred from the dataâ€”can help model this hidden structure. These latent variables capture unobserved factors that affect the relationship between predictors (_X_) and the outcome (_Y_).\n",
        "\n",
        "We model the relationship between the predictor variables (_X_) and the outcome variable (_Y_) with a latent variable (_Z_) as follows:\n",
        "\n",
        "$$\n",
        "Y = f(X, Z) + \\epsilon\n",
        "$$\n",
        "\n",
        "Where:\n",
        "- _Y_ is the observed outcome variable.\n",
        "- _X_ is the observed predictor variable(s).\n",
        "- _Z_ is the latent (unobserved) variable, which we aim to infer.\n",
        "- _f(X, Z)_ is the function that relates _X_ and _Z_ to _Y_.\n",
        "- _\\epsilon_ is the error term, typically assumed to be normally distributed with mean 0 and variance _\\sigma^2_.\n",
        "\n",
        "The latent variable _Z_ can represent various phenomena, such as group-level effects, time-varying trends, or individual-level factors, that are not captured by the observed predictors alone.\n",
        "\n",
        "## Considerations\n",
        "\n",
        "In Bayesian regression with latent variables, we consider the uncertainty in both the observed and latent variables. We declare prior distributions for the latent variables, in addition to the usual priors for regression coefficients and intercepts. These latent variables are often modeled using Gaussian distributions (_Normal_ priors) or more flexible distributions such as _Multivariate Normal_ for correlations among the latent variables.\n",
        "\n",
        "The goal is to infer the posterior distribution over both the parameters and the latent variables, given the observed data.\n",
        "\n",
        "## Example\n",
        "\n",
        "Below is an example code snippet demonstrating Bayesian regression with latent variables using TensorFlow Probability:\n",
        "\n",
        "::: {.panel-tabset group=\"language\"}\n",
        "## Python"
      ],
      "id": "760ba87b"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "from BI import bi, jnp\n",
        "\n",
        "\n",
        "# Setup device------------------------------------------------\n",
        "m = bi(platform='cpu')\n",
        "\n",
        "# Data Simulation ------------------------------------------------\n",
        "NY = 4  # Number of dependent variables or outcomes (e.g., dimensions for latent variables)\n",
        "NV = 8  # Number of observations or individual-level data points (e.g., subjects)\n",
        "N = 100\n",
        "K = 5\n",
        "a = 0.5\n",
        "# Generate the means and offsets for the data\n",
        "# means: Generate random normal means for each of the NY outcomes\n",
        "# offsets: Generate random normal offsets for each of the NV observations\n",
        "means = m.dist.normal(0, 1, shape=(NY,), sample=True, seed=10)\n",
        "offsets = m.dist.normal(0, 1, shape=(NV, 1), sample=True, seed=20)\n",
        "\n",
        "Y2 = offsets + means\n",
        "\n",
        "# Simulate individual-level random effects (e.g., random slopes or intercepts)\n",
        "# b_individual: A matrix of size (N, K) where N is the number of individuals and K is the number of covariates\n",
        "b_individual = m.dist.normal(0, 1, shape=(N, K), sample=True, seed=0)\n",
        "\n",
        "# mu: Add an additional effect 'a' to the individual-level random effects 'b_individual'\n",
        "# 'a' could represent a population-level effect or a baseline\n",
        "mu = b_individual + a\n",
        "\n",
        "# Convert Y2 to a JAX array for further computation in a JAX-based framework\n",
        "Y2 = jnp.array(Y2)\n",
        "\n",
        "\n",
        "# Set data ------------------------------------------------\n",
        "dat = dict(\n",
        "    NY = NY,\n",
        "    NV = NV,\n",
        "    Y2 = Y2\n",
        ")\n",
        "m.data_on_model = dat\n",
        "\n",
        "# Define model ------------------------------------------------\n",
        "def model(NY, NV, Y2):\n",
        "    means = m.dist.normal(0, 1, shape=(NY,), name='means')\n",
        "    offset = m.dist.normal(0, 1, shape=(NV, 1), name='offset')\n",
        "    sigma = m.dist.exponential(1, shape=(NY,), name='sigma')\n",
        "    tmp = jnp.tile(means, (NV, 1)).reshape(NV, NY)\n",
        "    mu_l = tmp + offset\n",
        "    m.dist.normal(mu_l, jnp.tile(sigma, [NV, 1]), obs=Y2)\n",
        "\n",
        "# Run sampler ------------------------------------------------\n",
        "m.fit(model)\n",
        "\n",
        "# Summary ------------------------------------------------\n",
        "m.summary()"
      ],
      "id": "ba9d2b8a",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## R\n",
        "``` R\n",
        "```\n",
        "![](travaux-routiers.png){fig-align=\"center\"}\n",
        ":::\n",
        "\n",
        "## Mathematical Details\n",
        "\n",
        "![](travaux-routiers.png){fig-align=\"center\"}\n",
        "<!---\n",
        "We can express the Bayesian latent variable model using probability distributions as follows:\n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "& p(Y | X, Z, W, \\sigma) = \\text{Normal}(X \\cdot W + Z, \\sigma^2) \\\\\n",
        "& p(Z) = \\text{Normal}(0, \\tau^2) \\\\\n",
        "& p(W) = \\text{Normal}(0, \\alpha^2) \\\\\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "Where:\n",
        "- _p(Y | X, Z, W, \\sigma)_ is the likelihood function for the observed outcome variable, which depends on both the observed predictor _X_ and the latent variable _Z_.\n",
        "- _p(Z)_ is the prior distribution for the latent variable _Z_, often modeled as _Normal_ with a mean of 0 and variance _\\tau^2_.\n",
        "- _p(W)_ is the prior distribution for the regression coefficient(s) _W_, typically assumed to follow a _Normal_ distribution with mean 0 and variance _\\alpha^2_.\n",
        "\n",
        "The latent variable _Z_ introduces additional flexibility to the model, capturing unobserved influences on the outcome _Y_.\n",
        "\n",
        "## Interpretation of Latent Variables\n",
        "\n",
        "- **Latent Variable (_Z_)**: Represents hidden factors not captured by the observed variables, allowing the model to explain more of the variance in the outcome. For instance, in a psychological model, _Z_ might represent a latent trait such as intelligence or anxiety that influences the outcome.\n",
        "  \n",
        "- **Posterior Inference**: The posterior distribution of the latent variable _Z_ can give insights into how much the unobserved factors contribute to the outcome.\n",
        "\n",
        "## Use Cases\n",
        "- **Latent Factors in Psychometrics**: In psychometric models, latent variables represent traits or abilities that are not directly observed, such as cognitive ability or personality traits.\n",
        "- **Time-Varying Effects**: Latent variables can represent unobserved time trends or individual-specific effects in time-series or longitudinal models.\n",
        "- **Mixed Models**: In hierarchical or mixed models, latent variables can represent group-specific intercepts or slopes.\n",
        "\n",
        "-->"
      ],
      "id": "05821928"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "/home/sosa/.local/share/jupyter/kernels/python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}